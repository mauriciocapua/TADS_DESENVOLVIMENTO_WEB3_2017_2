package negocio;

import java.io.File;
import java.io.FileInputStream;
import java.io.IOException;
import java.io.UnsupportedEncodingException;
import java.math.BigInteger;
import java.nio.charset.StandardCharsets;
import java.security.MessageDigest;
import java.security.NoSuchAlgorithmException;
import java.util.Base64;
import java.util.Scanner;
import java.util.regex.Pattern;

public class EncoderXML {

	private static final String[] TO_ESCAPE = new String[] { "\\", "^", ".", "$", "|", "(", ")", "[", "]", "*", "+",
			"?", "{", "}", "," };

	Scanner scanner = new Scanner(System.in);

	public String leituraDosDados() {
		String[] values = { "1", "1", "inglês", "Sex, Drugs and Rock'n'Roll", "2000-06-15", "Editora Abril", "1",
				"José da Silva", "png", "pokemon" };

		String livroXML = "";

		System.out.print("Digite o codigo do livro:");
		String codigo = escapar(values[0]);
		System.out.println("Digite o nÃºmero de traduções:");
		int numeroDeTitulos = Integer.parseInt(values[1]);
		String titulos = "";
		for (int j = 0; j < numeroDeTitulos; j++) {
			System.out.println("Digite a linguagem do tÃ­tulo:");
			titulos = titulos + " linguagem: " + escapar(values[2] + " ");
			System.out.println("Digite o tÃ­tulo :");
			titulos = titulos + escapar(values[3]) + "\" }";
			if (j < numeroDeTitulos - 1) {
				titulos = titulos + ",";
			}
		}

		System.out.println("Digite o dia de publicaÃ§Ã£o:");
		String dia = escapar("15");
		System.out.println("Digite o mÃªs de publicaÃ§Ã£o:");
		String mes = escapar("06");
		System.out.println("Digite o ano de publicaÃ§Ã£o:");
		String ano = escapar("2000");

		String publicacao = ano + "-" + mes + "-" + dia;

		System.out.println("Digite a editora:");
		String editora = escapar(values[5]);

		System.out.println("Digite o nÃºmero de autores:");
		int numeroDeAutores = Integer.parseInt(values[6]);

		String autores = "";

		for (int j = 0; j < numeroDeAutores; j++) {
			System.out.println("Digite o nome do autor NÂº" + (j + 1) + ":");
			autores = autores + "\"" + escapar(values[7]) + "\"";
			if (j < numeroDeAutores - 1) {
				autores = autores + ",";
			}
		}

		System.out.println("Digite o nome do arquivo para capa:");
		String capa = values[9];

		System.out.println("Digite o formato do arquivo:");
		String formato = escapar(values[8]);

		File file = new File(capa + "." + formato);
		String imagemBase64 = base64ficador(file);

		// livroXML = "livro = { codigo:" + codigo + ", titulo:[" + titulos + "],
		// publicacao:\"" + publicacao
		// + "\", editora:\"" + editora + "\", " + "autores:[" + autores + "], capa:{
		// formato:\"" + formato
		// + "\", valor:\"" + imagemBase64 + "\" } }";
		//

		livroXML = "<?xml version='1.0' encoding='UTF-8'?>" + "<livro>" + "<codigo>" + codigo + "</codigo>" + "<titulo>"
				+ titulos + "</titulo>" + "<publicacao>" + publicacao + "</publicacao>" + "<editora>" + editora
				+ "</editora>" + "<autores>" + "<autor>" + autores + "</autor>" + "</autores>" + "<capa formato='png'>"
				+ imagemBase64 + "</capa>" + "</livro>";

		/*
		 * livroXML =
		 * "livro = { codigo:1, titulo:[ { linguagem:\"english\", valor:\"Sex, Drugs and Rock'n'Roll\" },"
		 * +
		 * " { linguagem:\"portugues\", valor:\"Sexo, Drogas e Rock'n'Roll\" } ], publicacao:\"2000-06-15\","
		 * +
		 * " editora:\"Editora Abril\", autores:[ \"Josï¿½ da Silva\", \"Maria Brasil\" ],"
		 * + " capa:{ formato:\"jpg\", valor:\""+ imagemBase64 +"\" } }";
		 */
		return livroXML;
	}

	public String base64ficador(File file) {
		String encodedBase64 = null;

		try {
			FileInputStream fileInputStreamReader = new FileInputStream(file);
			byte[] bytes = new byte[(int) file.length()];
			fileInputStreamReader.read(bytes);
			encodedBase64 = new String(Base64.getEncoder().encode(bytes));
			fileInputStreamReader.close();
		} catch (IOException e) {
			e.printStackTrace();
		}

		return encodedBase64;
	}

	public String mD5ficador(String string) {
		MessageDigest md5 = null;
		try {
			md5 = MessageDigest.getInstance("MD5");
			md5.update(StandardCharsets.UTF_8.encode(string));

		} catch (NoSuchAlgorithmException e) {
			// TODO Auto-generated catch block
			e.printStackTrace();
		}
		return String.format("%032x", new BigInteger(1, md5.digest()));

	}

	public String escapar(String palavra) {
		// palavra = palavra.replaceAll("\"", "\\\\\"");
		System.out.println(palavra);
		Pattern escaper = Pattern.compile("([^a-zA-z0-9])");
		palavra = escaper.matcher(palavra).replaceAll("\\\\$1");
		System.out.println(palavra);
		return palavra;
	}

}
